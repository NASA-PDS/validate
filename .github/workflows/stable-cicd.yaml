# ğŸƒâ€â™€ï¸ Continuous Integration and Delivery: Stable
# ===============================================
#
# Note: for this workflow to succeed, the following secrets must be installed
# in the repository:
#
# ``ADMIN_GITHUB_TOKEN``
#     A personal access token of a user with collaborator or better access to
#     the project repository. You can generate this by visiting GitHub â†’
#     Settings â†’ Developer settings â†’ Personal access tokens â†’ Generate new
#     token. Give the token scopes on ``repo``, ``write:packages``,
#     ``delete:packages``, ``workflow``, and ``read:gpg_key``.
# ``CODE_SIGNING_KEY``
#     A *private* key with which we can sign artifacts.
# ``OSSRH_USERNAME``
#     Username for the Central Repository.
# ``OSSRH_PASSWORD``
#     Password for the Central Repository.
#


---

name: ğŸ˜Œ Stable integration & delivery


# Driving Event
# -------------
#
# What event starts this workflow: a push of a release tag. Note: according to
# https://git.io/JJZQt we have been doing our tag matching wrong. It's not
# regexp, it's not globâ€¦it's more likeâ€¦glob++ ğŸ˜®

on:
    push:
        tags:
            - 'release/*'
concurrency: roundup


# What to Do
# ----------
#
# Round up, yee-haw!

jobs:
    stable-assembly:
        name: ğŸ´ Stable Assembly
        runs-on: ubuntu-latest
        steps:
            -
                name: ğŸ’³ Checkout
                uses: actions/checkout@v4
                with:
                    lfs: true
                    token: ${{secrets.ADMIN_GITHUB_TOKEN}}
                    fetch-depth: 0
            -
                name: ğŸ’µ Maven Cache
                uses: actions/cache@v4
                with:
                    path: ~/.m2/repository
                    # The "key" used to indicate a set of cached files is the operating system runner
                    # plus "mvn" for Maven-specific builds, plus a hash of the `pom.xml` files, which
                    # should uniquely identify the dependent jars; plus "pds" because we pds-prefix
                    # everything with "pds" in PDSâ€”even when the context is obvious! ğŸ˜…
                    key: pds-${{runner.os}}-mvn-${{hashFiles('**/pom.xml')}}
                    # To restore a set of files, we only need to match a prefix of the saved key.
                    restore-keys: pds-${{runner.os}}-mvn-
            -
                name: ğŸ¤  Roundup
                uses: NASA-PDS/roundup-action@stable
                with:
                    assembly: stable
                    packages: openjdk11-jdk
                    maven-build-phases: install
                    maven-doc-phases: clean,site,site:stage
                    maven-stable-artifact-phases: clean,site,site:stage,deploy
                    documentation-dir: target/staging/validate
                env:
                    ossrh_username: ${{secrets.OSSRH_USERNAME}}
                    ossrh_password: ${{secrets.OSSRH_PASSWORD}}
                    CODE_SIGNING_KEY: ${{secrets.CODE_SIGNING_KEY}}
                    ADMIN_GITHUB_TOKEN: ${{secrets.ADMIN_GITHUB_TOKEN}}

            -
                name: ğŸ«™Â Tar and Tag Determination
                id: gettartag
                run: |
                    echo "tar_file=$(find ./target/ -maxdepth 1 -regextype posix-extended -regex '.*/.*-[0-9]+\.[0-9]+\.[0-9]+(-SNAPSHOT)?-bin\.tar\.gz')" >> $GITHUB_OUTPUT
                    echo "image_tag=$(echo ${{github.ref}} | awk -F/ '{print $NF}')" >> $GITHUB_OUTPUT
            -
                name: ğŸ’³ Docker Hub Identification
                uses: docker/login-action@v3
                with:
                    username: ${{secrets.DOCKERHUB_USERNAME}}
                    password: ${{secrets.DOCKERHUB_TOKEN}}
            -
                name: ğŸ°Â QEMU Multiple Machine Emulation
                uses: docker/setup-qemu-action@v3
            -
                name: ğŸš¢Â Docker Buildx
                uses: docker/setup-buildx-action@v3
            -
                name: ğŸ§±Â Image Construction and Local Publication
                uses: docker/build-push-action@v6
                with:
                    context: ./
                    file: ./docker/Dockerfile
                    build-args: tar_file=${{steps.gettartag.outputs.tar_file}}
                    platforms: linux/amd64,linux/arm64
                    push: false
                    load: true
                    tags: ${{secrets.DOCKERHUB_USERNAME}}/validate:${{steps.gettartag.outputs.image_tag}}
            -
                name: ğŸ•µï¸â€â™‚ï¸Â Image Vulnerability Scanning
                uses: anchore/scan-action@v5
                with:
                    fail-build: true
                    severity-cutoff: critical
                    image: ${{secrets.DOCKERHUB_USERNAME}}/validate:${{steps.gettartag.outputs.image_tag}}
            -
                name: ğŸ§±Â Image Construction and Remote Publication
                uses: docker/build-push-action@v6
                with:
                    context: ./
                    file: ./docker/Dockerfile
                    build-args: tar_file=${{steps.gettartag.outputs.tar_file}}
                    platforms: linux/amd64,linux/arm64
                    push: true
                    tags: ${{secrets.DOCKERHUB_USERNAME}}/validate:${{steps.gettartag.outputs.image_tag}}

...

# -*- mode: yaml; indent: 4; fill-column: 120; coding: utf-8 -*-
